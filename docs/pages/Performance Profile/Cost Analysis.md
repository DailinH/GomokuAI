## Cost Analysis

### Board 时空开销分析

    时间开销分析：
        由于需要在单线程的基础上将性能优化到极致，因此各种操作的开销需要尽量低。
        * 经查阅资料知，为了方便神经网络的训练，最好每一种棋子状态（黑/白/无）分别用一个容器存储。
          因此棋盘可以如此设计： Array[3] = { 状态容器(白子), 状态容器(无子), 状态容器(黑子) }。
        在此之上，对存储各状态所使用的容器进行分析：
        1. unordered_set<Position>: 特点是可以不用存储整个棋盘，只需存符合对应状态的位置即可。
           但是，经过profiler检测，实际上多数常用操作的开销相对来说显得过高了点。
        2. std::array<bool>: 特点是存储了整个棋盘，index代表位置，value表示该位置是否满足对应状态。
           优点是在当前设计下，每一种操作都可以做到非常快。但需要额外存储一个size_t数组来记录每种状态的棋子数目。
        3. bitset: 使用bitset,可以起到与std::array一样的效果（因为3是2的紧凑版本）。
           具体效率如何有待profiler检测。
    
    空间开销分析：
        由于这个对象可能会被频繁拷贝，若要考虑这点的话，拷贝成本需设计得尽量低。
        棋盘的存储有几种选择：
        1. bitset: 使用bitset存储整个棋盘。由于每个格子需要标记三种落子状态（黑/白/无），至少需要2bit存储。
           因此一个19*19的棋盘需要至少19*19*2=722bit=90.25Byte。
        2. pos -> player的map。一个unordered_map<Position, Player>在MSVC下为>=32Byte。一个{pos, player}对至少为3字节。
           由于采用Hash Table机制， 空间需求很可能更大……
        3. 同时间开销分析的2, 3。由于2是栈上数组，3是栈上bit列，因此它们的拷贝开销相对来说都较低一些。

### MCTS::expand 扩展策略分析

相关变量解释：

* \#1：一次expand只扩展一个结点，扩展完一层时各函数的调用次数；
* \#2：一次expand直接扩展一层结点，扩展完一层时各函数的调用次数。
* $E_1,E_2$：对应\#1 \#2情况下的expand函数时间复杂度。
* $h$：从根节点算起，当前蒙特卡洛树的树高。
* $n_i$：当前结点下，可下的位置数量。

|    函数    |      select       |          expand          |
| :--------: | :---------------: | :----------------------: |
| 单次复杂度 | $S(n_i)=O(N-n_i)$ | $E_1=O(1)$, $E_2=O(N-n)$ |
|    \#1     |     $(N-n)h$      |          $N-n$           |
|    \#2     |        $h$        |            $1$             |

默认根节点为棋盘初始状态时，总时间开销：

1. $(N-n)\sum_{n_i=h}^NS(n_i)+(N-n)E_1$
2. $\sum_{n_i=h}^NS(n_i)+E_2=\sum_{n_i=h}^NS(n_i)+(N-n)E_1$

目前，select()开销占比约50%。设：

1. MCTS从棋局刚开始时开始进行足够多次playout。
2. 最远扩展到了$n$层，第$i$层的结点来源于第$i-1$层的某$i-1$个结点。

则：

1. 第$i$层有$(i-1)(N-i)$个结点
2. select()在每一层都执行了大约同样多的次数（树高相较于playout次数很小）。

设优化前总时间为$T$, 优化后的时间占比应约为：

$$\frac{\frac{T}{2n}\sum_{i=0}^n\frac{1}{N-i}}{\frac{T}{2}+\frac{T}{2n}\sum_{i=0}^n\frac{1}{N-i}}≈\frac{\ln(\frac{N+1}{N-n})}{n+\ln(\frac{N+1}{N-n})}=1-\frac{1}{1+\ln(\frac{N+1}{N-n})/n}$$

当$N=255,n=127$时，上式约为$1-\frac{1}{1+\ln2/127}≈0.3\%$。